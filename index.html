<div id="dashboard" class="lg:col-span-2 space-y-8 hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-gray-800 p-6 rounded-xl border border-green-500/20">
            <h3 class="text-gray-400 text-xs font-bold uppercase mb-2 tracking-widest">Group MVP (Highest Avg)</h3>
            <div id="highestRated" class="text-2xl font-bold text-green-400">--</div>
        </div>
        <div class="bg-gray-800 p-6 rounded-xl border border-blue-500/20">
            <h3 class="text-gray-400 text-xs font-bold uppercase mb-2 tracking-widest">Most Watched</h3>
            <div id="topMovie" class="text-2xl font-bold text-blue-400">--</div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-gray-800 p-5 rounded-xl">
            <h3 class="text-yellow-500 text-sm font-bold uppercase mb-4 flex items-center gap-2">
                <span>ğŸ†</span> Top 5 Highest Rated
            </h3>
            <div id="top5Rated" class="space-y-2 text-sm"></div>
        </div>

        <div class="bg-gray-800 p-5 rounded-xl">
            <h3 class="text-red-500 text-sm font-bold uppercase mb-4 flex items-center gap-2">
                <span>ğŸ“‰</span> Bottom 5 Lowest Rated
            </h3>
            <div id="bottom5Rated" class="space-y-2 text-sm"></div>
        </div>
    </div>

    <div class="bg-gray-800 p-5 rounded-xl">
        <h3 class="text-blue-400 text-sm font-bold uppercase mb-4">ğŸ”¥ Top 5 Most Watched</h3>
        <div id="top5Watched" class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm"></div>
    </div>
</div>

<script>
    // ... keep your addInput function ...

    async function fetchAllData() {
        const inputs = document.querySelectorAll('.username-input');
        const usernames = Array.from(inputs).map(i => i.value.trim()).filter(v => v !== "");
        const date = document.getElementById('sinceDate').value;
        const btn = document.getElementById('fetchBtn');

        if (usernames.length === 0) return;

        btn.disabled = true;
        btn.innerText = "Processing Group Data...";

        try {
            const results = await Promise.all(usernames.map(user => 
                fetch(`/api/get-history?username=${user}&since=${date}`).then(res => res.json())
            ));

            const watchCounts = {}; 
            const ratingsMap = {}; // { Title: [4, 5, 3] }

            results.forEach((userData) => {
                userData.forEach(movie => {
                    const title = movie.letterboxd_filmtitle || movie.title;
                    
                    // Count watches
                    watchCounts[title] = (watchCounts[title] || 0) + 1;
                    
                    // Collect ratings
                    if(movie.letterboxd_memberrating) {
                        const val = parseFloat(movie.letterboxd_memberrating);
                        if(!ratingsMap[title]) ratingsMap[title] = [];
                        ratingsMap[title].push(val);
                    }
                });
            });

            // Calculate Averages
            const aggregatedStats = Object.keys(watchCounts).map(title => {
                const scores = ratingsMap[title] || [];
                return {
                    title: title,
                    watchCount: watchCounts[title],
                    avgRating: scores.length > 0 ? (scores.reduce((a, b) => a + b, 0) / scores.length) : null
                };
            });

            displayStats(aggregatedStats);
            document.getElementById('dashboard').classList.remove('hidden');
        } catch (err) {
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "Generate Report";
        }
    }

    function displayStats(stats) {
        // 1. Sort for Ratings (Filter out movies with no ratings)
        const ratedMovies = stats.filter(s => s.avgRating !== null)
                                .sort((a, b) => b.avgRating - a.avgRating);
        
        // 2. Sort for Watched
        const watchedMovies = [...stats].sort((a, b) => b.watchCount - a.watchCount);

        // UI: Top Highlight Cards
        document.getElementById('highestRated').innerText = ratedMovies[0]?.title || "N/A";
        document.getElementById('topMovie').innerText = watchedMovies[0]?.title || "N/A";

        // UI: Top 5 Rated
        renderList('top5Rated', ratedMovies.slice(0, 5), 'avgRating', 'â˜…');
        
        // UI: Bottom 5 Rated
        const bottom5 = [...ratedMovies].reverse().slice(0, 5);
        renderList('bottom5Rated', bottom5, 'avgRating', 'â˜…');

        // UI: Top 5 Watched
        renderList('top5Watched', watchedMovies.slice(0, 5), 'watchCount', ' watches');
    }

    function renderList(elementId, data, key, unit) {
        const container = document.getElementById(elementId);
        container.innerHTML = data.map((item, i) => `
            <div class="flex justify-between items-center bg-gray-700/30 p-2 rounded border-l-2 ${elementId.includes('top') ? 'border-green-500' : 'border-red-500'}">
                <span class="truncate pr-2"><span class="text-gray-500 mr-2">${i+1}.</span>${item.title}</span>
                <span class="font-mono font-bold whitespace-nowrap text-green-400">
                    ${key === 'avgRating' ? item[key].toFixed(1) : item[key]}${unit}
                </span>
            </div>
        `).join('') || '<p class="text-gray-500 italic">No data found</p>';
    }
</script>